#!/bin/bash

#-------------------------------------------------------------------------------
# Script that builds EOS and adds it to the local repository
#-------------------------------------------------------------------------------

# Delete left-over source rpms and then create the new one
rm -rf {{ buildroot_dir }}/SRPMS/eos-*.src.rpm
cd {{ eos_src_dir }}/build/
RELEASE=`git log --pretty=format:"%h" -1`

if test $? -ne 0; then
  echo "[!] Unable to get the git commit hash" 1>&2
  exit 1
fi

cmake ../ -DPACKAGEONLY=1 -DRELEASE=$RELEASE
make srpm

# Clean up tar archive of the project generated by srpm
rm -rf {{ eos_src_dir }}/eos-*.tar.gz

# Delete left-over EOS rpms built previously
rm -rf {{ buildroot_dir }}/RPMS/noarch/eos-*
rm -rf {{ buildroot_dir }}/RPMS/x86_64/eos-*

# Rebuild the EOS rpms
rpmbuild --rebuild {{ buildroot_dir }}/SRPMS/eos-*.src.rpm

# Add the new packages to the local repository
cp {{ buildroot_dir }}/RPMS/noarch/eos-* {{ localrepo_dir }}/
cp {{ buildroot_dir }}/RPMS/x86_64/eos-* {{ localrepo_dir }}/
cd {{ localrepo_dir }}

# Update repository
/usr/bin/createrepo {{ localrepo_dir }}
